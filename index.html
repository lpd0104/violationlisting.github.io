<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- Add Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- CSS file -->
    <link href="https://cdn.datatables.net/v/bs4/jszip-2.5.0/dt-1.13.4/b-2.3.6/b-html5-2.3.6/b-print-2.3.6/datatables.min.css" rel="stylesheet"/>
 
    <title>Admin Login</title>

    <style>
      body {
        background-image: url('bg.jpg');
        background-position: center;
      }
      
      .card {
        backdrop-filter: blur(12px) saturate(55%);
        -webkit-backdrop-filter: blur(12px) saturate(55%);
        background-color: rgba(17, 25, 40, 0.56);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.125);
      }

      .table {
        color: white;
        backdrop-filter: blur(12px) saturate(55%);
        -webkit-backdrop-filter: blur(12px) saturate(55%);
        background-color: rgba(17, 25, 40, 0.56);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.125);  
      }

      .buttons-csv {
        background-color: #28a745;
        border-color: #28a745;  
      }

      .page-item.active .page-link {
        background-color: #28a745;
        border-color: #28a745;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: 200px;
        padding: 15px;
        background-color: #333;
        color: #fff;
        z-index: 1; /* Add this line */
      }

      .sidebar-sticky {
        position: sticky;
        top: 0;
      }

      .sidebar ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .sidebar ul li a {
        display: block;
        padding: 10px;
        color: #fff;
        text-decoration: none;
      }

      .sidebar ul li a.active {
        background-color: #555;
      }

      .content {
        margin-left: 200px;
        padding: 15px;
        z-index: 0; /* Add this line */
      }
    </style>
  </head>
  <body class="text-white">


    <div id="loginScreen" class="d-none">
      <div class="container mt-5">
        <div class="row justify-content-center">
          
          <div class="col-md-6">
            
            <div class="card">
              <div class="card-header d-flex">
                <h4>Login</h4>
                <div id="loading" class="mx-2 d-none justify-content-center align-items-center">
                  <div class="spinner-border" role="status">
                  </div>
                </div>
              </div>

              <div class="card-body">
                <form id="#login-form">
                  <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" class="form-control" id="email" placeholder="Enter email" required>
                    <div class="invalid-feedback">Please enter a valid email address.</div>
                  </div>
                  <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" class="form-control" id="password" placeholder="Enter password" required>
                    <div class="invalid-feedback">Please enter a password.</div>
                  </div>
                  <p class="text-center"><a href="?page=forgot" class="text-white">Forgot Password?</a></p>
                  <button id="submit" type="submit" class="btn btn-success btn-block mb-3">Login</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="menuScreen" class="d-none">
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-2 col-md-3 col-sm-4 bg-dark sidebar">
            <div class="sidebar-sticky">
              <ul class="nav flex-column">
                <li class="nav-item">
                  <a class="nav-link active" href="?page=dashboard">
                    <i class="fas fa-list"></i> Dashboard
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="?page=violations">
                    <i class="fas fa-list"></i> Violations
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="?page=users">
                    <i class="fas fa-user"></i> Users
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="?page=logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                  </a>
                </li>
              </ul>
            </div>
          </div>

          <div class="col-lg-10 col-md-9 col-sm-8 content">

            <div id="loadingMain" class="d-flex justify-content-center">
              <div class="spinner-border" role="status">
              </div>
            </div>

            <div id="dashboardScreen" class="d-none">
              <div id="cardHolder" class="row justify-content-center">
                
              </div>
            </div>

            <div id="violationsScreen" class="d-none">
              <h2>Violations</h2>
              <br>
              <table id="violationsTable" class="table table-striped table-success table-bordered table-sm" style="width:100%">
                <thead>
                  <tr>
                    <th>Ref #</th>
                    <th>Full Name</th>
                    <th>Address</th>
                    <th>Birthdate</th>
                    <th>License #</th>
                    <th>Violations</th>
                    <th>Total Fee</th>
                    <th>Plate #</th>
                    <th>Registered #</th>
                    <th>Vehicle #</th>
                    <th>Vehicle Type</th>
                    <th>License Confiscated?</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>

            <div id="usersScreen" class="d-none">
              <div class="row align-items-center">
                <div class="col">
                  <h2>Users</h2>
                </div>
                <div class="col-auto">
                  <button type="button" class="btn btn-success" data-toggle="modal" data-target="#addUserModal">+</button>
                </div>
              </div>
              <br>
              <table id="usersTable" class="table table-striped table-success table-bordered table-sm" style="width:100%">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>

          </div> 
        </div>     
      </div>  

      <!-- Add User Modal -->
      <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content bg-dark">
            <div class="modal-header">
              <div class="d-flex">
                <h5 class="modal-title" id="addUserModalLabel">Add User</h5>
                <div id="loading2" class="mx-2 d-none justify-content-center align-items-center">
                  <div class="spinner-border" role="status">
                  </div>
                </div>
              </div>
              <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="addUserForm">
                <div class="mb-3">
                  <label for="emailAddUser" class="form-label">Email</label>
                  <input type="email" class="form-control" id="emailAddUser" placeHolder="Enter email" required>
                </div>
                <div class="mb-3">
                  <label for="passwordAddUser" class="form-label">Password</label>
                  <input type="password" class="form-control" id="passwordAddUser" placeHolder="Enter password" required>
                </div>
                <div class="mb-3">
                  <label for="type" class="form-label">Type</label>
                  <select class="form-control" id="typeAddUser" required>
                    <option value="">Choose Type...</option>
                    <option value="enforcer">Enforcer</option>
                    <option value="admin">Admin</option>
                  </select>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button id="addUserBtn" type="submit" class="btn btn-success" form="addUserForm">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Bootstrap JavaScript -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    
    <!-- JavaScript files -->
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.11.2/datatables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/v/bs4/jszip-2.5.0/dt-1.13.4/b-2.3.6/b-html5-2.3.6/b-print-2.3.6/datatables.min.js"></script>

    <script src="https://kit.fontawesome.com/618080302d.js" crossorigin="anonymous"></script>


    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-analytics.js";
      import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
      import { doc, getDoc, getFirestore, getDocs, collection, onSnapshot, setDoc} from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyAYu3wN2JvXTBI5gNOV1Nn8FlJzuUdwQZQ",
        authDomain: "licenseplate-45ab1.firebaseapp.com",
        databaseURL: "https://licenseplate-45ab1-default-rtdb.firebaseio.com",
        projectId: "licenseplate-45ab1",
        storageBucket: "licenseplate-45ab1.appspot.com",
        messagingSenderId: "943920119656",
        appId: "1:943920119656:web:e7021424dbf721c14220dd",
        measurementId: "G-MYX8SM7CV3"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth();
      const db = getFirestore();

      $(document).ready(function() {

        routePage();   

        // Add click event to all nav links
        $('.nav-link').click(function(e) {
          // Remove active class from all nav links
          $('.nav-link').removeClass('active');
          // Add active class to clicked link
          $(this).addClass('active');
        });


        startLogin();
        
        // Add event listener for field change
        $('#email, #password').on('input', function(event) {
          // Remove error message when user starts typing
          if (this.checkValidity()) {
            $(this).removeClass('is-invalid');
          }
        });

        var violationsDataTable;
        var usersDataTable;

        function routePage() {
          // Get the URL query parameters
          var queryParams = new URLSearchParams(window.location.search);
          
          // Check if the 'page' parameter is present and set to 'dashboard'
          if (queryParams.has('page')) {
            var page = queryParams.get('page');
            // DASHBOARD
            if (page === 'dashboard') {
              showDashboardPage(page);
            }
            // VIOLATIONS
            else if (page === 'violations') {
              showViolationsPage(page);
            }
            // USERS
            else if (page === 'users') {
              showUsersPage(page);
            } 
            else if (page === 'logout') {
              signOut(auth)
              .then(() => {
                window.location.href = 'index.html';
              })
              .catch((error) => {
                // An error happened.
              });
            }
          } else {
            $('#loginScreen').removeClass('d-none');
          }
        }

        function startLogin() {
          // Add event listener for form submission
          $('#submit').click(function(event) {
            event.preventDefault();
            // Get form fields
            var emailInput = $('#email');
            var passwordInput = $('#password');
            var email = emailInput.val();
            var password = passwordInput.val();
            
            // Check if email and password fields are valid
            if (!emailInput[0].checkValidity()) {
              // If not valid, show error message
              emailInput.addClass('is-invalid');
            } else if (!passwordInput[0].checkValidity()) {
              // If password field is empty, show error message
              passwordInput.addClass('is-invalid');
              passwordInput.siblings('.invalid-feedback').text('Please enter a password.');
            } else {

              // Show loading spinner
              $('#loading').removeClass('d-none');

              // Sign in with email and password using Firebase Auth
              signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                  // User authenticated successfully
                  checkUserLevel(userCredential.user.uid);
                })
                .catch((error) => {
                  // Handle Firebase Auth errors
                  var errorCode = error.code;
                  var errorMessage = error.message;
                  console.error(errorCode + ': ' + errorMessage);

                  if (errorCode === 'auth/user-not-found' || errorCode === 'auth/wrong-password') {
                    alert('Invalid credentials!');
                  } else if (errorCode === 'auth/too-many-requests') {
                    alert('Access to this account has been temporarily disabled due to many failed login attempts. You can immediately restore it by resetting your password or you can try again later.');
                  }

                  // Hide loading spinner
                  $('#loading').addClass('d-none');
                });
              }
          });
        }

        // Function to check the user's level
        function checkUserLevel(uid) {
          const userRef = doc(db, "users", uid);

          getDoc(userRef).then((doc) => {
            if (doc.exists()) {
              // Get user level from document data
              var userLevel = doc.data().type;

              if (userLevel === 'admin') {
                // User is an admin
                successfulLogin();
              } else {
                // Show error message
                alert('You do not have permission to access this page.');
              }
            } else {
              // User document does not exist
              console.log('User document does not exist');
            }
            // Hide loading spinner
            $('#loading').addClass('d-none');

          }).catch((error) => {
            // Handle errors
            console.log(error);

            // Hide loading spinner
            $('#loading').addClass('d-none');
          });
        }

        function successfulLogin() {
          console.log('Successful logged in');

          // Redirect to dashboard page
          window.location.href = '?page=dashboard';
        }

        function setActivePage(page) {
          // Show Menu
          $('#menuScreen').removeClass('d-none');

          // Set active class to menu item based on current page URL
          $('.nav-link').each(function(){
            var linkPage = this.href.substring(this.href.lastIndexOf('/')+1);

            if (linkPage.includes(page)) {
              $(this).addClass('active');
            } else {
              $(this).removeClass('active');
            }
          });
        }

        function showDashboardPage(page) {
          setActivePage(page);
          $('#loginScreen').addClass('d-none');
          $('#violationsScreen').addClass('d-none');
          $('#usersScreen').addClass('d-none');

          // Show current page
          $('#dashboardScreen').removeClass('d-none');
        
          onAuthStateChanged(auth, (user) => {
            if (user) {
              // User is signed in, show the dashboard
              loadDashboardPage();
            } else {
              // User is not signed in, redirect to login page
              window.location.href = 'index.html';
            }
          });
        }

        function loadDashboardPage() {
          console.log('Showing dashboard page');
          
          // Get Violation List
          const violationList = collection(db, 'violationList/');
          onSnapshot(violationList, (violationListQuerySnapshot) => {

            violationListQuerySnapshot.forEach((vl) => {
              // Get Plate No Details
              const plateNoDetails = collection(db, 'plateNoDetails/');
              var pvlCount = 0;
              onSnapshot(plateNoDetails, (plateNoDetailsQuerySnapshot) => {
                plateNoDetailsQuerySnapshot.forEach((pl) => {
                  pl.data().violations.forEach((pvl) => {
                    if (vl.id == pvl) {

                      console.log(vl.data().type); 
                      pvlCount++;
                    }
                  });
                });
                //console.log(pvlCount);
                if (pvlCount != 0) {
                  $('#cardHolder').append(`
                  <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="card h-100">
                      <div class="card-body text-center">
                        <h2 class="h1 card-title text-success">`+ pvlCount +`</h2>
                        <p class="card-text">`+ vl.data().type +`</p>
                      </div>
                    </div>
                  </div>`);
                }
                $('#loadingMain').removeClass('d-flex');
                $('#loadingMain').addClass('d-none');
                pvlCount = 0;
              });
            });
                        
          });          
        }

        function showViolationsPage(page) {
          setActivePage(page);
          $('#loginScreen').addClass('d-none');
          $('#dashboardScreen').addClass('d-none');
          $('#usersScreen').addClass('d-none');

          // Show current page
          $('#violationsScreen').removeClass('d-none');
          
          // Populate Violations Table
          violationsDataTable = $('#violationsTable').DataTable({
            
            dom: 'Bfrtip',
            buttons: [
                'csv'
            ]
          });
          violationsDataTable.clear(); // clear the table before adding new rows

          onAuthStateChanged(auth, (user) => {
            if (user) {
              // User is signed in, show the violations
              loadViolationsPage();
            } else {
              // User is not signed in, redirect to login page
              window.location.href = 'index.html';
            }
          });
        }

        function loadViolationsPage() {
          console.log('Showing violation page');
          
          // Get Plate No Details
          const plateNoDetails = collection(db, 'plateNoDetails/');
          onSnapshot(plateNoDetails, (plateNoDetailsQuerySnapshot) => {

            const plateNoDetailsCount = plateNoDetailsQuerySnapshot.size;

            let violationString = ''; 

            let violationAmount = 0;
            let i = 0;

            plateNoDetailsQuerySnapshot.forEach((pd) => {
              console.log(pd.id, " => ", pd.data());

              // Get Violation List
              const violationList = collection(db, 'violationList/');
              onSnapshot(violationList, (violationListQuerySnapshot) => {
                i++;

                var pdData = pd.data();
                var licenseConfString = 'No';
                if (pdData.licconf == 1) {
                  licenseConfString = 'Yes';
                }
                

                pdData.violations.forEach((vID) => {    
                  
                  violationListQuerySnapshot.forEach((vl) => {

                    if (vl.id == vID) {
                      violationString = violationString + '*' + vl.data().type + '-' + vl.data().amount + '\n';
                      violationAmount = violationAmount + parseFloat(vl.data().amount);
                    }
                  });
                  
                });

                violationsDataTable.row.add([pd.id, pdData.fname + ' ' + pdData.mname[0] + '. ' + pdData.lname, pdData.address, pdData.bdate, pdData.lnumber, violationString, violationAmount.toFixed(2), pdData.no, pdData.rnumber, pdData.vnumber, pdData.vtype, licenseConfString]);
                
                if (i == plateNoDetailsCount) {
                  console.log(violationString);
                  violationsDataTable.order([[ 0, "desc" ]]).draw();

                  $('#loadingMain').removeClass('d-flex');
                  $('#loadingMain').addClass('d-none');
                }
                violationString = '';
                violationAmount = 0;
              });
            });


          });
        }

        function showUsersPage(page) {
          setActivePage(page);
          $('#loginScreen').addClass('d-none');
          $('#dashboardScreen').addClass('d-none');
          $('#violationsScreen').addClass('d-none');

          // Show current page
          $('#usersScreen').removeClass('d-none');
          
          // Populate Users Table
          usersDataTable = $('#usersTable').DataTable({
            
            dom: 'Bfrtip',
            buttons: [
                'csv'
            ]
          });

          // Show the modal when the plus button is clicked
          $('#addUserModal').on('show.bs.modal', function() {
            // Clear the form values when the modal is shown
            $('#addUserForm').trigger('reset');
          });

          $('#addUserModal').on('click', '#addUserBtn', function(e) {
            e.preventDefault();

            // Show loading spinner
            $('#loading2').removeClass('d-none');

            // Get the input values from the modal
            const email = $('#emailAddUser').val();
            const password = $('#passwordAddUser').val();
            const userType = $('#typeAddUser').val();

            // Call the createUserWithEmailAndPassword method
            createUserWithEmailAndPassword(auth, email, password)
              .then((userCredential) => {

                // Signed up user
                const user = userCredential.user;

                var users = collection(db, '/users');

                // Add the user type to the Firestore database
                setDoc(doc(users, user.uid), {
                  email: email,
                  type: userType,
                  id: user.uid
                })
                .then(() => {
                  // User added successfully
                  console.log('User added successfully');
                  $('#addUserModal').modal('hide');

                  // Hide loading spinner
                  $('#loading2').addClass('d-none');
                })
                .catch((error) => {
                  // Error adding user
                  console.error('Error adding user: ', error);

                  // Hide loading spinner
                  $('#loading2').addClass('d-none');
                });

              })
              .catch((error) => {
                var errorCode = error.code;
                var errorMessage = error.message;
                // Error signing up user
                console.error(errorCode + ': ' + errorMessage);
                if (errorCode === 'auth/email-already-in-use') {
                  alert('Email already taken!');
                }
                // Hide loading spinner
                $('#loading2').addClass('d-none');
              });
          });

          onAuthStateChanged(auth, (user) => {
            if (user) {
              // User is signed in, show the users
              loadUsersPage();
            } else {
              // User is not signed in, redirect to login page
              window.location.href = 'index.html';
            }
          });
        }

        function loadUsersPage() {
          console.log('Showing user page');
          
          // Get User Details
          const users = collection(db, 'users/');
          onSnapshot(users, (usersQuerySnapshot) => {
            usersDataTable.clear(); // clear the table before adding new rows
            usersQuerySnapshot.forEach((u) => {
              console.log(u.id, " => ", u.data());

              var uData = u.data();
              usersDataTable.row.add([uData.email, uData.type]);

            });

            usersDataTable.draw();    

            $('#loadingMain').removeClass('d-flex');
            $('#loadingMain').addClass('d-none');
          });
        }
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- Add Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- CSS file -->
    <link href="https://cdn.datatables.net/v/bs4/jszip-2.5.0/dt-1.13.4/b-2.3.6/b-html5-2.3.6/date-1.4.1/sb-1.4.2/datatables.min.css" rel="stylesheet"/>

 
    <title>Admin Login</title>

    <style>
      body {
        background-image: url("bg_v1_wide.png");
        position: relative;
      }

      #header {
        height: 56px;
        /*margin-left:-120px;
        margin-right:-164px;
        margin-top:-15px;*/
        background-color: rgba(0, 123, 255, 0.6)!important;
      }

      .grayscale {
        filter: grayscale(95%);
        opacity: 0.1;
      }

      .img-container {
        position: relative;
      }

      .img-container img {
        display: block;
        max-width: 100%;
        height: auto;
      }

      .img-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .dashboard-card a {
        color: black;
        text-decoration: none;
      }

      .dataTables_length {
        margin-top: 1rem;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        padding: 15px;
        z-index: 1;
        overflow-y: auto;
      }

      .sidebar-sticky {
        position: sticky;
        top: 0;
        height: 100%;
      }

      .sidebar ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .sidebar ul li a {
        display: block;
        padding: 10px;
        color: #000;
        text-decoration: none;
      }

      .sidebar ul li a.active {
        background-color: #007bff;
        color: #fff;
      }

      .content {
        /*margin-left: 200px;*/
        /*padding-top: 15px;
        padding-bottom: 15px;
        padding-left: 120px;
        padding-right: 64px;*/
        z-index: 0; /* Add this line */
      }

      @media print {
        body * {
          visibility: hidden;
        }
        #receiptModal, #receiptModal * {
          visibility: visible;
        }
        #receiptModal {
          position: absolute;
          left: 0;
          top: 0;
        }
      }     


    </style>
  </head>
  <body>


    <div id="loginScreen" class="d-none">
      <div class="container-fluid vh-100 d-flex justify-content-center align-items-center">
        <div class="row w-100">
          

          <div class="col-md-1">
          </div>

          <div class="col-md-4 d-flex justify-content-center align-items-center img-container">
            <img src="logo-v2.png" class="grayscale my-4" alt="Background image">
            <img class="img-overlay" src="title-logo-v2.png" alt="Overlay image">
          </div>

          <div class="col-md-1">
          </div>

          <div class="col-md-4">
            
            <div class="card bg-light shadow shadow-lg">
              <div class="card-header d-flex align-items-center justify-content-center">
                <div class="p-3 text-center">
                  <h5>Welcome to Sta. Cruz</h5><h5>Traffic Management System</h5>
                </div>
                <div id="loading" class="mx-2 d-none justify-content-center align-items-center">
                  <div class="spinner-border text-primary" role="status">
                  </div>
                </div>
              </div>

              <div class="card-body p-sm-5">
                <form id="login-form">
                  <label for="email" class="mt-sm-3">Email</label>
                  <div class="input-group mb-sm-4">
                    
                    <div class="input-group-prepend">
                      <span class="input-group-text">
                        <i class="fa fa-envelope"></i>
                      </span>
                    </div>
                    <input type="email" class="form-control" id="email" placeholder="@gmail.com" required>

                    <div class="invalid-feedback">Please enter a valid email address from gmail.com only.</div>
                  </div>

                  <label for="password">Password</label>
                  <div class="input-group mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text">
                        <i class="fa fa-lock"></i>
                      </span>
                    </div>
                    <input type="password" class="form-control" id="password" placeholder="password" required>
                    <div class="invalid-feedback">Please enter a password.</div>
                  </div>
                  <p class="text-center p-sm-3"><a href="?page=reset-password">Forgot Password?</a></p>
                  <button id="submit" type="submit" class="btn btn-primary btn-block mb-sm-3">Login</button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-2">
          </div>
        </div>
      </div>
    </div>

    <div id="resetScreen" class="d-none mt-5">
      <div class="d-flex justify-content-center">
        <div class="card bg-light w-sm-50">
          <div class="card-header ">
            <div class="d-flex justify-content-between align-items-center">
              <a href="#" class="nav-link text-dark" onclick="history.back(); return false;">
                <i class="fas fa-arrow-left"></i>
              </a>
              <h5 class="w-100 m-0">Reset Password</h5>
            </div>
          </div>
          <div class="card-body p-sm-5">
            <form>
              <p class="text-muted">Note: An email will be sent on how to reset your password.</p>
              <div class="form-group">
                <label class="form-label" for="resetEmail">Registered Email</label>
                <input class="form-control" type="email" name="resetEmail" id="resetEmail" placeholder="Enter your registered email" required>
              </div>
              <button id="resetPasswordButton" class="btn btn-primary btn-block mt-4" type="button">Send</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="mainScreen" class="d-none vh-100">
      <!--nav class="navbar navbar-expand-md fixed-top d-sm-none p-0">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse bg-light" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item ">
              <a class="nav-link active" href="?page=dashboard">
                <i class="fas fa-list"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="?page=transactions">
                <i class="fas fa-list"></i> Transactions
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="?page=generate-reports">
                <i class="fas fa-list-alt"></i> Generate Report
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="?page=users">
                <i class="fas fa-user"></i> Users
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="?page=violations">
                <i class="fas fa-list"></i> Violations
              </a>
            </li>
            <li class="nav-item">
              <a id="logoutButton" class="nav-link" href="#">
                <i class="fas fa-sign-out-alt"></i> Logout
              </a>
            </li>
          </ul>
        </div>
      </nav-->
      <div class="container-fluid h-100">
        <div class="row h-100">
          <div class="col-lg-2 p-0 col-md-3 col-sm-4 bg-light sidebar h-100 d-none d-sm-block">
            <div id="menuScreen"  class="sidebar-sticky h-100">
              <ul class="nav flex-column">
                <li class="nav-item">
                  <img src="logo-v2.png" class="img-fluid p-4">
                </li>
                <li class="nav-item">
                  <a class="nav-link active p-3" href="?page=dashboard">
                    <i class="fas fa-list"></i> Dashboard
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link p-3" href="?page=transactions">
                    <i class="fas fa-list"></i> Transactions
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link p-3" href="?page=generate-reports">
                    <i class="fas fa-list-alt"></i> Generate Report
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link p-3" href="?page=users">
                    <i class="fas fa-user"></i> Users
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link p-3" href="?page=violations">
                    <i class="fas fa-list"></i> Violations
                  </a>
                </li>
                <li class="nav-item">
                  <a id="logoutButton" class="nav-link p-3" href="#">
                    <i class="fas fa-sign-out-alt"></i> Logout
                  </a>
                </li>
              </ul>
            </div>
          </div>

          <div class="col-lg-2 p-0 col-md-3 col-sm-4">
          </div>

          <div class="col-lg-10 p-0 col-md-9 col-sm-8 content">


            <div id="header" class="bg-primary mb-4 p-4 d-flex justify-content-between align-items-center">
          
                <h3 class="text-white text-center flex-grow-1"></h3>
                <div><span class="text-white" id="profileName"></span>&nbsp;&nbsp;<a href="?page=profile"><i class="text-white fa fa-user"></i></a></div>
            </div>

            <div id="loadingMain" class="d-flex justify-content-center">
              <div class="spinner-border text-white" role="status">
              </div>
            </div>

            <div class="container">

              <div id="dashboardScreen" class="d-none">
                <div class="row mt-5">
                  <div class="col-sm-4 mb-3">
                    <div class="card bg-danger text-white">
                      <div cass="card-body">
                        <h1 id="totalViolations" class="p-4 text-center">-</h1>
                      </div>
                      <div class="card-footer">
                        Total No. of Violations
                      </div>
                    </div>
                  </div>

                  <div class="col-sm-4 mb-3">
                    <div class="card bg-success text-white">
                      <div cass="card-body">
                        <h1 id="paidViolatorsPerDay" class="p-4 text-center">-</h1>
                      </div>
                      <div class="card-footer">
                        No. of Paid Violators (per Day)
                      </div>
                    </div>
                  </div>

                  <div class="col-sm-4 mb-3">
                    <div class="card bg-warning text-white">
                      <div cass="card-body">
                        <h1 id="totalAmountPerDay" class="p-4 text-center">-</h1>
                      </div>
                      <div class="card-footer">
                        Total Amount (per Day)
                      </div>
                    </div>
                  </div>
                </div>
                <hr class="border-white m-5">
                <div id="cardHolder" class="row justify-content-center">
                    
                </div>
              </div>

              <h4 class="text-white mb-3" id="userViolationsSubtitle"></h4>
              <div id="userViolationsScreen" class="d-none">
                <div class="card bg-light p-4">
                  <table id="userViolationsTable" class="table table-striped table-light table-bordered table-sm" style="width:100%; font-size: 12px">
                    <thead>
                      <tr>
                        <th>Full Name</th>
                        <th>License Plate</th>
                        <th>Violation</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>
              </div>

              <div id="transactionsScreen" class="d-none">
                <div class="card bg-light p-4 table-responsive">
                  <button type="button" class="btn btn-primary btn-sm buttonsPrint">Print/PDF</button>
                  <br>
                  <table id="transactionsTable" class="table table-striped table-light table-bordered table-sm" style="width:100%; font-size: 12px;">
                    <thead>
                      <tr>
                        <th>Reference #</th>
                        <th>Full Name</th>
                        <th>Address</th>
                        <th>Birthdate</th>
                        <th>License #</th>
                        <th>Plate #</th>
                        <th>Registered #</th>
                        <th>Vehicle #</th>
                        <th>Vehicle Type</th>
                        <th>License Confiscated?</th>
                        <th>Enforcer</th>
                        <th>Violations</th>
                        <th>Total Fee</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                    <tfoot>
                      <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th class="total-column"></th>
                        <th></th>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              <div id="reportsScreen" class="d-none">
                <div class="card bg-light p-4 table-responsive">
                  <button type="button" class="btn btn-primary btn-sm buttonsPrint">Print/PDF</button>
                  <br>
                  <table id="reportsTable" class="table table-striped table-light table-bordered table-sm" style="width:100%; font-size: 12px;">
                
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Reference #</th>
                        <th>Full Name</th>
                        <th>License #</th>
                        <th>Violations</th>
                        <th>Paid Violation Fee</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                    <tfoot>
                      <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th class="total-column"></th>
                      </tr>
                    </tfoot>

                  </table>
                  <br>
                </div>
              </div>

              <div id="usersScreen" class="d-none">
                <button type="button" class="btn btn-success mb-3" data-toggle="modal" data-target="#addUserModal"><span><i class="fa fa-user"></i>&nbsp;&nbsp;Add User</span></button>
                
                <div class="card bg-light p-4 table-responsive">
                  <table id="usersTable" class="table table-striped table-light table-bordered table-sm" style="width:100%; font-size: 12px">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Type</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>
                
              </div>

              <div id="violationsScreen" class="d-none">
                <button type="button" class="btn btn-success mb-3" data-toggle="modal" data-target="#addViolationModal"><span><i class="fa fa-list"></i>&nbsp;&nbsp;Add Violation</span></button>
                <div class="card bg-light p-4 table-responsive">
                  <table id="violationsTable" class="table table-striped table-light table-bordered table-sm" style="width:100%; font-size: 12px">
                    <thead>
                      <tr>
                        <th>Tag</th>
                        <th>Type</th>
                        <th>Amount</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>
              </div>

              <div id="profileScreen" class="d-none">
                <div class="d-flex justify-content-center mb-3">
                  <div class="card bg-light w-50">
                    <div class="card-header ">
                      <h5>Info</h5>
                    </div>
                    <div class="card-body ">
                      <div class="form-group">
                        <label class="form-label">Name</label>
                        <input class="form-control" type="text" id="nameProfile" disabled>
                      </div>
                      <div class="form-group">
                        <label class="form-label" >Email</label>
                        <input class="form-control" type="text" id="emailProfile" disabled>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-center">
                  <div class="card bg-light w-50">
                    <div class="card-header ">
                      <h5>Change Password</h5>
                    </div>
                    <div class="card-body ">
                      <form>
                        <div class="form-group">
                          <label class="form-label" for="newPassword">New Password</label>
                          <input class="form-control  " type="password" name="newPassword" id="newPassword" placeholder="Enter new password" required>
                        </div>
                        <div class="form-group">
                          <label class="form-label" for="confirmPassword">Confirm Password</label>
                          <input class="form-control  " type="password" name="confirmPassword" id="confirmPassword" placeholder="Confirm password" required>
                        </div>
                        <button id="saveNewPassword" class="btn btn-primary btn-block mt-4" type="button">Save</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

              <div id="violationsScreen" class="d-none">
                <button type="button" class="btn btn-success mb-3" data-toggle="modal" data-target="#addViolationModal"><span><i class="fa fa-list"></i>&nbsp;&nbsp;Add Violation</span></button>
                <div class="card bg-light p-4">
                  <table id="violationsTable" class="table table-striped table-light table-bordered table-sm" style="width:100%; font-size: 12px">
                    <thead>
                      <tr>
                        <th>Tag</th>
                        <th>Type</th>
                        <th>Amount</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            

          </div> 
        </div>     
      </div>  

      <!-- Add User Modal -->
      <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content bg-light">
            <div class="modal-header">
              <div class="d-flex">
                <h5 class="modal-title" id="addUserModalLabel">Add User</h5>
                <div id="loading2" class="mx-2 d-none justify-content-center align-items-center">
                  <div class="spinner-border text-primary" role="status">
                  </div>
                </div>
              </div>
              <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="addUserForm">
                <div class="mb-3">
                  <label for="nameAddUser" class="form-label">Name</label>
                  <input type="text" class="form-control" id="nameAddUser" placeHolder="Enter name" required>
                </div>
                <div class="mb-3">
                  <label for="emailAddUser" class="form-label">Email</label>
                  <input type="email" class="form-control" id="emailAddUser" placeHolder="Enter email" required>
                </div>
                <div class="mb-3">
                  <label for="passwordAddUser" class="form-label">Password</label>
                  <input type="password" class="form-control" id="passwordAddUser" placeHolder="Enter password" required>
                </div>
                <div class="mb-3">
                  <label for="cpasswordAddUser" class="form-label">Confirm Password</label>
                  <input type="password" class="form-control" id="cpasswordAddUser" placeHolder="Confirm password" required>
                </div>
                <div class="mb-3">
                  <label for="type" class="form-label">Type</label>
                  <select class="form-control" id="typeAddUser" required>
                    <option value="">Choose Type...</option>
                    <option value="enforcer">Enforcer</option>
                    <option value="admin">Admin</option>
                  </select>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button id="addUserBtn" type="submit" class="btn btn-success" form="addUserForm">Save</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Violation Modal -->
      <div class="modal fade" id="addViolationModal" tabindex="-1" role="dialog" aria-labelledby="addViolationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content bg-light">
            <div class="modal-header">
              <div class="d-flex">
                <h5 class="modal-title" id="addViolationModalLabel">Add Violation</h5>
                <div id="loading2" class="mx-2 d-none justify-content-center align-items-center">
                  <div class="spinner-border text-primary" role="status">
                  </div>
                </div>
              </div>
              <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form>
                <div class="mb-3">
                  <label for="tagAddViolation" class="form-label">Tag</label>
                  <input type="text" class="form-control" id="tagAddViolation" placeHolder="Enter tag" required>
                </div>
                <div class="mb-3">
                  <label for="typeAddViolation" class="form-label">Type</label>
                  <input type="text" class="form-control" id="typeAddViolation" placeHolder="Enter type" required>
                </div>
                <div class="mb-3">
                  <label for="amountAddViolation" class="form-label">Amount</label>
                  <input type="number" class="form-control" id="amountAddViolation" placeHolder="Enter amount" required>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button id="addViolationBtn" type="submit" class="btn btn-success" form="addViolationForm">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Receipt Modal -->
    <div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true" >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="receiptModalLabel">Receipt Details</h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="card p-4 text-center mb-2">
              <h2>OFFICIAL RECEIPT</h2>
              <h6>Republic of the Philippines</h6>
              <h6>OFFICE OF THE TREASURER</h6>
              <h6>PROVINCE OF LAGUNA</h6>
            </div>
            <div class="card mb-2">
              <table class="text-center table-bordered">
                <thead>
                  <tr>
                    <th>DATE</th>
                    <th>ORIGINAL</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td id="receiptDate"></td>
                    <td id="receiptID"></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="card p-1 mb-2">
              <h6>PAYOR&nbsp;&nbsp;<span id="receiptPayor"></span></h6>
            </div>
            <div class="card mb-2">
              <table id="receiptAmountDetails" class="text-center table-bordered">
                <thead>
                  <tr>
                    <th>NATURE OF COLLECTION</th>
                    <th>ACCOUNT CODE</th>
                    <th>AMOUNT</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
            <div class="card mb-2">
              <table class="table-bordered">
                <thead>
                  <tr>
                    <th><input type="checkbox">&nbsp;Cash</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Received the amount stated above</td>
                    <td><br><br>By:<br><input id="receiptOfficer" type="text" placeholder="Enter name"><br>COLLECTING OFFICER</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="window.print()">Print</button>
          </div>
        </div>
      </div>
    </div>

    <img class="d-none" src="https://i.ibb.co/g71X3Gj/logo-header1.png" width="100px">
    <img class="d-none" src="https://i.ibb.co/dtwnvdF/logo-header2.png" width="100px">

    <!-- Add Bootstrap JavaScript -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    
    <!-- JavaScript files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/v/bs4/jszip-2.5.0/dt-1.13.4/b-2.3.6/b-html5-2.3.6/date-1.4.1/sb-1.4.2/datatables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <script src="https://kit.fontawesome.com/618080302d.js" crossorigin="anonymous"></script>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-analytics.js";
      import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword, updatePassword,sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
      import { doc, getDoc, getFirestore, getDocs, collection, onSnapshot, setDoc, updateDoc} from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyAYu3wN2JvXTBI5gNOV1Nn8FlJzuUdwQZQ",
        authDomain: "licenseplate-45ab1.firebaseapp.com",
        databaseURL: "https://licenseplate-45ab1-default-rtdb.firebaseio.com",
        projectId: "licenseplate-45ab1",
        storageBucket: "licenseplate-45ab1.appspot.com",
        messagingSenderId: "943920119656",
        appId: "1:943920119656:web:e7021424dbf721c14220dd",
        measurementId: "G-MYX8SM7CV3"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth();
      const db = getFirestore();


      // Declare DataTables
      var userViolationsDataTable;
      var transactionsDataTable;
      var reportsDataTable;
      var usersDataTable;
      var violationsDataTable;

      $(document).ready(function() {

        routePage();   

        addActiveLink();

        handleLogout();

        handleLogin();
        
        handleLoginInput();

        
      });

      function routePage() {
        // Get the URL query parameters
        var queryParams = new URLSearchParams(window.location.search);
        
        if (queryParams.has('page') && !queryParams.has('id')) {
          var page = queryParams.get('page');
          console.log(page);
          // DASHBOARD
          if (page === 'dashboard') {
            showDashboardPage(page);
          }
          // TRANSACTIONS
          else if (page === 'transactions') {
            showTransactionsPage(page);
          }
          // REPORTS
          else if (page === 'generate-reports') {
            showReportsPage(page);
          }
          // USERS
          else if (page === 'users') {
            showUsersPage(page);
          } 
          // VIOLATIONS
          else if (page === 'violations') {
            showViolationsPage(page);
          } 
          // PROFILE
          else if (page === 'profile') {
            showProfilePage(page);
          } 
          // RESET PASSWORD
          else if (page === 'reset-password') {
            showResetPage(page);
          }
          else {
            $('#loginScreen').removeClass('d-none');
          }
        } else if (queryParams.has('page') && queryParams.has('id')) {
          var page = queryParams.get('page');
          var id = queryParams.get('id');
          var title = queryParams.get('title');
          // USER VIOLATIONS
          if (page.includes('users-with-violation')) {
            showUserViolationsPage(page, id, title);
          } 
        } else {
          $('#loginScreen').removeClass('d-none');
        }
      }

      function addActiveLink() {
        // Add click event to all nav links
        $('.nav-link').click(function(e) {
          // Remove active class from all nav links
          $('.nav-link').removeClass('active');
          // Add active class to clicked link
          $(this).addClass('active');
        });


        $('#logoutButton').removeClass('active');
      }

      function handleLogout() {
        $('#logoutButton').on('click', function(e) {
          e.preventDefault();
          if (confirm("Are you sure you want to log out?")) {
            signOut(auth)
            .then(() => {
              window.location.href = 'index.html';
            })
            .catch((error) => {
              // An error happened.
            });
          }
        });
      }

      function handleLogin() {
        // Add event listener for form submission
        $('#submit').click(function(event) {
          event.preventDefault();
          // Get form fields
          var emailInput = $('#email');
          var passwordInput = $('#password');
          var email = emailInput.val();
          var password = passwordInput.val();
          
          // Check if email and password fields are valid
          if (!emailInput[0].checkValidity() || !email.includes('gmail.com')) {
            // If not valid, show error message
            emailInput.addClass('is-invalid');
          } else if (!passwordInput[0].checkValidity()) {
            // If password field is empty, show error message
            passwordInput.addClass('is-invalid');
            passwordInput.siblings('.invalid-feedback').text('Please enter a password.');
          } else {

            // Show loading spinner
            $('#loading').removeClass('d-none');

            // Sign in with email and password using Firebase Auth
            signInWithEmailAndPassword(auth, email, password)
              .then((userCredential) => {

                localStorage.setItem('email', email); 
                // User authenticated successfully
                checkUserLevel(userCredential.user.uid);
              })
              .catch((error) => {
                // Handle Firebase Auth errors
                var errorCode = error.code;
                var errorMessage = error.message;
                console.error(errorCode + ': ' + errorMessage);

                if (errorCode === 'auth/user-not-found' || errorCode === 'auth/wrong-password') {
                  alert('Invalid credentials!');
                } else if (errorCode === 'auth/too-many-requests') {
                  alert('Access to this account has been temporarily disabled due to many failed login attempts. You can immediately restore it by resetting your password or you can try again later.');
                }

                // Hide loading spinner
                $('#loading').addClass('d-none');
              });
            }
        });
      }

      function checkUserLevel(uid) {
        const userRef = doc(db, "users", uid);

        getDoc(userRef).then((doc) => {
          if (doc.exists()) {
            // Get user level from document data
            var userLevel = doc.data().type;
            var userDisabled = doc.data().disabled;

            if (userLevel === 'admin' && !userDisabled) {
              const adminName = doc.data().name;
              localStorage.setItem('adminName', adminName); 
          
              // User is an admin
              successfulLogin();
            } else {
              // Show error message
              alert('You do not have permission to access this page.');
            }
          } else {
            // User document does not exist
            console.log('User document does not exist');
          }
          // Hide loading spinner
          $('#loading').addClass('d-none');

        }).catch((error) => {
          // Handle errors
          console.log(error);

          // Hide loading spinner
          $('#loading').addClass('d-none');
        });
      }

      function successfulLogin() {
        console.log('Successful logged in');

        // Redirect to dashboard page
        window.location.href = '?page=dashboard';
      }

      function handleLoginInput() {
        // Add event listener for field change
        $('#email, #password').on('input', function(event) {
          // Remove error message when user starts typing
          if (this.checkValidity()) {
            $(this).removeClass('is-invalid');
          }
        });
      }

      function setActivePage(page) {
        // Show Main
        $('#mainScreen').removeClass('d-none');

        // Set active class to menu item based on current page URL
        $('.nav-link').each(function(){
          var linkPage = this.href.substring(this.href.lastIndexOf('/')+1);

          var actualPage = '';
          if (page.includes('users-with-violation')) {
            actualPage = 'Users with Violation';
          } else if (page.includes('generate-reports')) {
            actualPage = 'Generate Reports';
          } else if (page.includes('reset-password')) {
            actualPage = 'Reset Password';
          } else {
            actualPage = page
          }
          document.title = actualPage.charAt(0).toUpperCase() + actualPage.slice(1);
          $('#header h3').text(document.title);
          
          if (linkPage.includes(page)) {
            $(this).addClass('active');
          } else {
            $(this).removeClass('active');
          }
        });

        const adminName = localStorage.getItem('adminName');
        $('#profileName').text(adminName);
      }

      function showDashboardPage(page) {
        setActivePage(page);

        // Show current page
        $('#dashboardScreen').removeClass('d-none');
      
        onAuthStateChanged(auth, (user) => {
          if (user) {
            // User is signed in
            loadDashboardPage();
          } else {
            // User is not signed in, redirect to login page
            window.location.href = 'index.html';
          }
        });
      }

      function loadDashboardPage() {
        console.log('Showing dashboard page');

        // Get Violation List
        const transactionsList = collection(db, 'violationList/');
        onSnapshot(transactionsList, async (transactionsListQuerySnapshot) => {
          $('#cardHolder').empty();

          const promises = [];
          let totalViolation = 0;
          let totalAmountPerDay = 0.00;
          let totalViolatorsPaidPerDay = 0;
          let totalViolationsList = 0;
          transactionsListQuerySnapshot.forEach((vl) => {
                    totalViolationsList++;
            // Get Plate No Details
            const plateNoDetails = collection(db, 'plateNoDetails/');
            const promise = new Promise((resolve, reject) => {
              onSnapshot(plateNoDetails, (plateNoDetailsQuerySnapshot) => {
                let pvlCount = 0;
                plateNoDetailsQuerySnapshot.forEach((pl) => {


                  var paymentDate = moment(pl.data().payment.date).format('YYYY-MM-DD');
                  var currentDate = moment().format('YYYY-MM-DD');

                  if (pl.data().payment.paid) {

                    if (paymentDate == currentDate) {
                      totalViolatorsPaidPerDay++;
                    }
                  }

                  pl.data().violations.forEach((v) => {
                    const vData = v.split(',');
                    const pvl = vData[0];
                    const amount = vData[2];
                    if (vl.id == pvl) {
                      pvlCount++;
                      totalViolation++;
                      if (pl.data().payment.paid) {
                        if (paymentDate == currentDate) {
                          totalAmountPerDay = totalAmountPerDay + parseFloat(amount);
                        }
                      }
                    }
                  });
                });
                if (pvlCount != 0) {
                  $('#cardHolder').append(`
                      <div class="dashboard-card col-lg-3 col-md-4 col-sm-6 mb-4">
                        <a href="?page=users-with-violation&id=`+vl.id+`&title=`+vl.data().type+`" class="card bg-primary text-white square h-100">
                          <div class="card-header d-flex align-items-center" style="height:5rem">
                            <p class="card-text">`+ vl.data().type +`</p>
                          </div>
                          <div class="card-body d-flex align-items-center" style="height:10rem">
                            <h2 class="h1 w-100 text-center">`+ pvlCount +`</h2>
                          </div>
                        </a>
                      </div>`);
                }
                pvlCount = 0;
                resolve();
              });
            });
            promises.push(promise);
          });

          await Promise.all(promises);

          $('#totalViolations').text(totalViolation);
          $('#paidViolatorsPerDay').text(totalViolatorsPaidPerDay/totalViolationsList);
          $('#totalAmountPerDay').text(totalAmountPerDay.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}));

          $('#loadingMain').removeClass('d-flex');
          $('#loadingMain').addClass('d-none');
        });
      }

      function showUserViolationsPage(page, id, title) {
        setActivePage(page);
        $('a[href="?page=dashboard"]').addClass('active');

        $('#userViolationsSubtitle').text(title); 

        // Show current page
        $('#userViolationsScreen').removeClass('d-none');
        
        // Populate User Violations Table
        userViolationsDataTable = $('#userViolationsTable').DataTable({
          pageLength: 50,
          dom: 'Blfrtip',
          buttons: [
            {
              extend: 'excel',
              text: 'Export to Excel',
            }
          ]
        });


        onAuthStateChanged(auth, (user) => {
          if (user) {
            // User is signed in
            loadUserViolationsPage(id, title);
          } else {
            // User is not signed in, redirect to login page
            window.location.href = 'index.html';
          }
        });
      }

      function loadUserViolationsPage(id, title) {
        
        // Get PlateNoDetails
        const plateNoDetails = collection(db, 'plateNoDetails/');
        onSnapshot(plateNoDetails, (plateNoDetailsQuerySnapshot) => {
          userViolationsDataTable.clear(); // clear the table before adding new rows

          plateNoDetailsQuerySnapshot.forEach((pd) => {
            console.log(pd.id, " => ", pd.data());

            var pdData = pd.data(); 
            pdData.violations.forEach((v) => {
              var vData = v.split(',');
              var pv = vData[0];
              if (pv == id) {                  
                userViolationsDataTable.row.add([pdData.fname + ' ' + pdData.mname[0] + '. ' + pdData.lname, pdData.lnumber, title]);
              }
            });

          });

          userViolationsDataTable.draw();    

          $('#loadingMain').removeClass('d-flex');
          $('#loadingMain').addClass('d-none');
        });
      }

      function showTransactionsPage(page) {
        setActivePage(page);

        // Show current page
        $('#transactionsScreen').removeClass('d-none');
        
        // Populate Transactions Table
        transactionsDataTable = $('#transactionsTable').DataTable({
          pageLength: 50,
          dom: 'Blfrtip',
          buttons:[
            {
              extend: 'searchBuilder',
              config: {
                depthLimit: 2,
              }
            }
            ,{
              extend: 'excel',
              text: 'Export to Excel',
            }
          ],
          columnDefs: [
            {
              targets: [3],
              type: 'date',
              render: function (data, type, row) {
                // Parse date string to moment.js object
                var date = moment(data, 'M/D/YYYY');
                // Format date as required
                return date.format('YYYY-MM-DD');
              }
            }
          ]
        });

        transactionsDataTable.on( 'draw.dt', function () {
            updateTotal('#transactionsTable', 12);
        });

        onAuthStateChanged(auth, (user) => {
          if (user) {
            // User is signed in
            loadTransactionsPage();
          } else {
            // User is not signed in, redirect to login page
            window.location.href = 'index.html';
          }
        });
      }

      function loadTransactionsPage() {


        printPage('#transactionsScreen', transactionsDataTable, '#transactionsTable', 'Transactions');
        
        // Get Plate No Details
        const plateNoDetails = collection(db, 'plateNoDetails/');
        onSnapshot(plateNoDetails, (plateNoDetailsQuerySnapshot) => {

          let transactionsString = ''; 
          let transactionsAmount = 0;
          transactionsDataTable.clear();

          plateNoDetailsQuerySnapshot.forEach((pd) => {
            //console.log(pd.id, " => ", pd.data());

            var pdData = pd.data();
            var licenseConfString = 'No';
            if (pdData.licconf == 1) {
              licenseConfString = 'Yes';
            }
            

            pdData.violations.forEach((v, index) => {
              var vData = v.split(',');
              var vID = vData[0];
              var type = vData[1];
              var amount = vData[2];

              transactionsString = transactionsString + '*' + type + '-' + amount + '\r\n<br>';
              transactionsAmount = transactionsAmount + parseFloat(amount);
            });

            var button = '<button class="btn btn-success btn-sm settle-button" data-reference="' + pd.id + '" data-amount="'+ transactionsAmount.toFixed(2) +'">Settle</button>';
            if (pdData.payment.paid == true) {
              button = '<button class="btn btn-dark btn-sm " disabled>Paid</button>'
            }

            transactionsDataTable.row.add([
              pd.id,
              pdData.fname + ' ' + pdData.mname[0] + '. ' + pdData.lname,
              pdData.address,
              pdData.bdate,
              pdData.lnumber,
              pdData.no,
              pdData.rnumber,
              pdData.vnumber,
              pdData.vtype,
              licenseConfString,
              pdData.enforcerName,
              transactionsString,
              transactionsAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}),
              button
            ]);

            transactionsString = '';
            transactionsAmount = 0;
              

          });

          transactionsDataTable.order([[ 0, "desc" ]]).draw();

          $('#loadingMain').removeClass('d-flex');
          $('#loadingMain').addClass('d-none');

          $('#transactionsTable').on('click', '.settle-button', function() {
            const reference = $(this).data('reference');
            const paidAmount = $(this).data('amount');
            const button = $(this);

            // Update the amount in Firebase
            const transactionRef = doc(db, 'plateNoDetails', reference.toString());


            var today = new Date();
            var day = today.getDate();
            var month = today.getMonth() + 1; // month is zero-based, so we add 1
            var year = today.getFullYear();
            var currentDate = month + '/' + day + '/' + year;

            updateDoc(transactionRef, {
              payment: {
                paid: true,
                date: currentDate,
                amount: paidAmount
              }
            })
            .then(() => {
              // Update the button text and disable the button
              button.text('Paid');
              button.removeClass('btn-success');
              button.addClass('btn-dark');
              button.prop('disabled', true);
              console.log("Document successfully updated!");

              // Get the receipt details from Firebase
              getDoc(transactionRef).then((doc) => {
                const receiptDetails = doc.data();
                
                console.log(currentDate); // output: "5/3/2023"

                // Display the receipt details in the modal
                $('#receiptDate').text(currentDate);
                $('#receiptPayor').text(receiptDetails.fname + ' ' + receiptDetails.mname[0] + '. ' + receiptDetails.lname)
                $('#receiptID').text(receiptDetails.id);
                var total = 0.00;
                $('#receiptAmountDetails tbody').empty();

                receiptDetails.violations.forEach((v, index) => {
                  var vData = v.split(',');
                  var tag = vData[0];
                  var type = vData[1];
                  var amount = vData[2];
                  $('#receiptAmountDetails tbody').append('<tr><td>' + type + '</td><td>' + tag + '</td><td>' + amount + '</td></tr>');
                  total = total + parseFloat(amount);
                });
                $('#receiptAmountDetails tbody').append('<tr><td>TOTAL</td><td></td><td>'+ total.toFixed(2) +'</td></tr>');

                const adminName = localStorage.getItem('adminName');

                $('#receiptOfficer').val(adminName);

                $('#receiptModal').modal('show');
              }).catch((error) => {
                console.error('Error getting receipt details:', error);
              });
            }).catch((error) => {
              console.error('Error updating amount:', error);
            });
          });
        });
      }

      function showReportsPage(page) {
        setActivePage(page);

        // Show current page
        $('#reportsScreen').removeClass('d-none');
        
        // Populate Reports Table
        reportsDataTable = $('#reportsTable').DataTable({
          buttons:[
            {
              extend: 'searchBuilder',
              config: {
                depthLimit: 2,
              }
            }
            ,{
              extend: 'excel',
              text: 'Export to Excel',
            }
          ],
          dom: 'Blfrtip',
          pageLength: 50,
          columnDefs: [
            {
              targets: [0],
              type: 'date',
              render: function (data, type, row) {
                // Parse date string to moment.js object
                var date = moment(data, 'M/D/YYYY');
                // Format date as required
                return date.format('YYYY-MM-DD');
              }
            }
          ]
        });

        reportsDataTable.on( 'draw.dt', function () {
            updateTotal('#reportsTable', 5);
        });

        onAuthStateChanged(auth, (user) => {
          if (user) {
            // User is signed in
            loadReportsPage();
          } else {
            // User is not signed in, redirect to login page
            window.location.href = 'index.html';
          }
        });
      }

      function updateTotal(tableID, columnNum) {
        var total = 0;
        $(tableID +' tbody tr').each(function() {
            var value = parseInt($(this).find('td:eq('+columnNum+')').text().replace(/,/g, ''));
            total += isNaN(value) ? 0 : value;
        });

        $(tableID +' tfoot tr th.total-column').text(total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}));
      }

      function printPage(screenID, dataTable, tableID, title) {
        $(screenID + ' .buttonsPrint').on('click', function() {
          //reportsDataTable
          // Remove unwanted elements from the table HTML
          var tableHtml = $(dataTable.table().container()).find(tableID).html();
          
          // Open a new window and write the table HTML to it
          var newWindow = window.open('', '', 'fullscreen=yes');
          newWindow.document.write('<html><head><title>Print Table</title>');
          newWindow.document.write(`
            <style>
              td, th {border: 1px solid #dee2e6;padding: 5px;}
              .container1 {
                display: flex;
              }
              .column1 {
                flex: 1;
                padding: 10px;
                display: flex;
                justify-content: center;
                align-items: center;
              }
            </style></head><body>`);
          newWindow.document.write(`
            <div class="container1">
              <div class="column1">
                <img src="https://i.ibb.co/g71X3Gj/logo-header1.png" width="100px">
              </div>
              <div class="column1">
                <div style="text-align: center">
                  Republic of the Philippines<br>
                  Province of Laguna<br>
                  <b>Municipality of Santa Cruz</b></br><br>
                  <b>SANTA CRUZ TRAFFIC MANAGEMENT OFFICE</b>
                </div>
              </div>
              <div class="column1">
                <img src="https://i.ibb.co/dtwnvdF/logo-header2.png" width="100px">
              </div>
            </div>
            <hr>`);
          newWindow.document.write('<h3>'+title+'</h3><table style="width:100%; font-size: 12px; background-color: #fdfdfe; border: 1px solid #dee2e6; color: #212529;border-collapse: collapse;">');
          newWindow.document.write(tableHtml);
          newWindow.document.write('</table></body></html>');
          
          // Print and close the new window
          newWindow.print();
          newWindow.close();
        });
      }


      function loadReportsPage() {
        printPage('#reportsScreen', reportsDataTable, '#reportsTable', 'Report');
        /*
        $('#reportsScreen .buttonsPrint').on('click', function() {
          //reportsDataTable
          // Remove unwanted elements from the table HTML
          var tableHtml = $(reportsDataTable.table().container()).find('#reportsTable').html();
          
          // Open a new window and write the table HTML to it
          var newWindow = window.open('', '', 'fullscreen=yes');
          newWindow.document.write('<html><head><title>Print Table</title>');
          newWindow.document.write(`
            <style>
              td, th {border: 1px solid #dee2e6;padding: 5px;}
              .container1 {
                display: flex;
              }
              .column1 {
                flex: 1;
                padding: 10px;
                display: flex;
                justify-content: center;
                align-items: center;
              }
            </style></head><body>`);
          newWindow.document.write(`
            <div class="container1">
              <div class="column1">
                <img src="https://i.ibb.co/g71X3Gj/logo-header1.png" width="100px">
              </div>
              <div class="column1">
                <div style="text-align: center">
                  Republic of the Philippines<br>
                  Province of Laguna<br>
                  <b>Municipality of Santa Cruz</b></br><br>
                  <b>SANTA CRUZ TRAFFIC MANAGEMENT OFFICE</b>
                </div>
              </div>
              <div class="column1">
                <img src="https://i.ibb.co/dtwnvdF/logo-header2.png" width="100px">
              </div>
            </div>
            <hr>`);
          newWindow.document.write('<h3>Report</h3><table style="width:100%; font-size: 12px; background-color: #fdfdfe; border: 1px solid #dee2e6; color: #212529;border-collapse: collapse;">');
          newWindow.document.write(tableHtml);
          newWindow.document.write('</table></body></html>');
          
          // Print and close the new window
          newWindow.print();
          newWindow.close();
        });
        */
        
        // Get Plate No Details
        const plateNoDetails = collection(db, 'plateNoDetails/');
        onSnapshot(plateNoDetails, (plateNoDetailsQuerySnapshot) => {

          const plateNoDetailsCount = plateNoDetailsQuerySnapshot.size;

          let transactionsString = ''; 

          reportsDataTable.clear();


          plateNoDetailsQuerySnapshot.forEach((pd) => {
            //console.log(pd.id, " => ", pd.data());

            var pdData = pd.data();
            var licenseConfString = 'No';
            if (pdData.licconf == 1) {
              licenseConfString = 'Yes';
            }
            

            pdData.violations.forEach((v, index) => {
              var vData = v.split(',');
              var type = vData[1];
              var amount = parseFloat(vData[2]);
              transactionsString = transactionsString + '*' + type + '-' + amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '\r\n<br>';
            });

            reportsDataTable.row.add([
              pdData.payment.date,
              pd.id,
              pdData.fname + ' ' + pdData.mname[0] + '. ' + pdData.lname,
              pdData.no,
              transactionsString,
              parseFloat(pdData.payment.amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})
            ]);
            
            transactionsString = '';
          });

          reportsDataTable.order([[ 0, "desc" ]]).draw();
          $('#loadingMain').removeClass('d-flex');
          $('#loadingMain').addClass('d-none');
        });
      }

      function showUsersPage(page) {
        setActivePage(page);

        // Show current page
        $('#usersScreen').removeClass('d-none');
        
        // Populate Users Table
        usersDataTable = $('#usersTable').DataTable({
          pageLength: 50,
          dom: 'Blfrtip',
          buttons: [
            {
              extend: 'excel',
              text: 'Export to Excel',
            }
          ]
        });

        // Show the modal when the plus button is clicked
        $('#addUserModal').on('show.bs.modal', function() {
          // Clear the form values when the modal is shown
          $('#addUserForm').trigger('reset');
        });

        $('#addUserModal').on('click', '#addUserBtn', function(e) {
          e.preventDefault();

          // Show loading spinner
          $('#loading2').removeClass('d-none');

          const userType = $('#typeAddUser').val();

          if (userType === 'enforcer') {
            signup();
          } else {
            var adminCount = 0;
            // Get admin users count
            const users = collection(db, 'users/');
            onSnapshot(users, (usersQuerySnapshot) => {
              usersQuerySnapshot.forEach((u) => {

                var uData = u.data();
                if (uData.type == 'admin') {
                  adminCount++;
                }
              });

              if (adminCount >= 2) {
                alert('Admin account must not be greater than 2!');

                // Hide loading spinner
                $('#loading2').addClass('d-none');
              } else {
                signup();
              }
            });
          }
          
        });

        onAuthStateChanged(auth, (user) => {
          if (user) {
            // User is signed in
            loadUsersPage();
          } else {
            // User is not signed in, redirect to login page
            window.location.href = 'index.html';
          }
        });
      }

      function signup() {
        // Get the input values from the modal
        const name = $('#nameAddUser').val();
        const email = $('#emailAddUser').val();
        const password = $('#passwordAddUser').val();
        const cpassword = $('#cpasswordAddUser').val();
        const userType = $('#typeAddUser').val();

        if (cpassword != password) {
          alert('Password and Confirm Password must be matched!');

          // Hide loading spinner
          $('#loading2').addClass('d-none');
          return;
        }

        // Call the createUserWithEmailAndPassword method
        createUserWithEmailAndPassword(auth, email, password)
          .then((userCredential) => {

            // Signed up user
            const user = userCredential.user;

            var users = collection(db, '/users');

            // Add the user type to the Firestore database
            setDoc(doc(users, user.uid), {
              name: name,
              email: email,
              type: userType,
              id: user.uid,
              disabled: false,
            })
            .then(() => {
              // User added successfully
              console.log('User added successfully');
              $('#addUserModal').modal('hide');

              // Hide loading spinner
              $('#loading2').addClass('d-none');
            })
            .catch((error) => {
              // Error adding user
              console.error('Error adding user: ', error);

              // Hide loading spinner
              $('#loading2').addClass('d-none');
            });

          })
          .catch((error) => {
            var errorCode = error.code;
            var errorMessage = error.message;
            // Error signing up user
            console.error(errorCode + ': ' + errorMessage);
            if (errorCode === 'auth/email-already-in-use') {
              alert('Email already taken!');
            } else if (errorCode === 'auth/weak-password') {
              alert('Password should be at least 6 characters!');
            }
            // Hide loading spinner
            $('#loading2').addClass('d-none');
          });
      }

      function loadUsersPage() {
        
        // Get User Details
        const users = collection(db, 'users/');
        onSnapshot(users, (usersQuerySnapshot) => {
          usersDataTable.clear(); // clear the table before adding new rows

          usersQuerySnapshot.forEach((u) => {

            var uData = u.data();
            var disableBtn = '';
  
            if (!uData.disabled) {
              disableBtn = '<button class="btn btn-sm btn-danger button-disable" data-id="'+u.id+'">Disable</button>';
            } else {
              disableBtn = '<button class="btn btn-sm btn-success button-enable" data-id="'+u.id+'">Enable</button>';
            }
            usersDataTable.row.add([uData.name, uData.email, uData.type, disableBtn]);
          });

          usersDataTable.draw();   

          $('#usersTable').on('click', '.button-disable', function() {
            const id = $(this).data('id');
            disableUser(id, true);
          }) 

          $('#usersTable').on('click', '.button-enable', function() {
            const id = $(this).data('id');
            disableUser(id, false);
          }) 

          $('#loadingMain').removeClass('d-flex');
          $('#loadingMain').addClass('d-none');
        });
      }

      function disableUser(userId, status) {
        const userRef = doc(db, 'users', userId);
        
        updateDoc(userRef, {
          disabled: status
        }).then(() => {
          if (status) {
            console.log('User disabled successfully');
          } else {
            console.log('User enabled successfully');
          }
        }).catch((error) => {
          console.error('Error disabling user:', error);
        });
      }

      function showViolationsPage(page) {
        setActivePage(page);

        // Show current page
        $('#violationsScreen').removeClass('d-none');
        
        // Populate Users Table
        violationsDataTable = $('#violationsTable').DataTable({
          pageLength: 50,
          dom: 'Blfrtip',
          buttons: [
            {
              extend: 'excel',
              text: 'Export to Excel',
            }
          ]
        });

        // Show the modal when the plus button is clicked
        $('#addViolationModal').on('show.bs.modal', function() {
          // Clear the form values when the modal is shown
          $('#addViolationForm').trigger('reset');
        });

        $('#addViolationModal').on('click', '#addViolationBtn', function(e) {
          addViolation();
        });

        onAuthStateChanged(auth, (user) => {
          if (user) {
            // User is signed in
            loadViolationsPage();
          } else {
            // User is not signed in, redirect to login page
            window.location.href = 'index.html';
          }
        });
      }

      function addViolation() {
        // Get the input values from the modal
        const tag = $('#tagAddViolation').val();
        const type = $('#typeAddViolation').val();
        const amount = $('#amountAddViolation').val();

        var violations = collection(db, '/violationList');

        // Add the user type to the Firestore database
        setDoc(doc(violations, tag), {
          id: tag,
          type: type,
          amount: amount
        })
        .then(() => {
          // Violation added successfully
          console.log('Violation added successfully');
          $('#addViolationModal').modal('hide');

          // Hide loading spinner
          $('#loading2').addClass('d-none');
        })
        .catch((error) => {
          // Error adding user
          console.error('Error adding violation: ', error);

          // Hide loading spinner
          $('#loading2').addClass('d-none');
        });

          
      }

      function loadViolationsPage() {
        
        // Get User Details
        const violations = collection(db, 'violationList/');
        onSnapshot(violations, (violationsQuerySnapshot) => {
          violationsDataTable.clear(); // clear the table before adding new rows

          violationsQuerySnapshot.forEach((v) => {

            var vData = v.data();
            violationsDataTable.row.add([
              vData.id,
              vData.type,
              '<span class="amount">' + vData.amount + '</span>' +
              '<button class="btn btn-primary btn-sm edit-amount ml-2"><span><i class="fa fa-edit"></i></span></button>',
              ''
            ]);

          });

          violationsDataTable.draw();

          // Handle edit button clicks
          $('#violationsTable tbody').on('click', '.edit-amount', function() {
            const $row = $(this).closest('tr');
            const $amount = $row.find('.amount');
            const $editButton = $(this);

            console.log($amount.text());

            // Replace the amount with a textbox and save/cancel buttons
            $amount.html('<input type="number" class="form-control" value="' + $amount.text() + '">' +
              '<button class="btn btn-success btn-sm save-amount" type="button" value="Save"><span><i class="fa fa-check"></i></span></button>' +
              '<button class="btn btn-danger btn-sm cancel-amount" type="button" value="Cancel"><span><i class="fa fa-times"></i></span></button>');

            // Hide the edit button
            $editButton.hide();
          });

          // Handle cancel button clicks
          $('#violationsTable tbody').on('click', '.cancel-amount', function() {
            const $row = $(this).closest('tr');
            const $amount = $row.find('.amount');
            const $editButton = $row.find('.edit-amount');

            // Replace the textbox and save/cancel buttons with the original amount and edit button
            $amount.html($amount.data('original-amount'));
            $editButton.show();
          });

          // Handle save button clicks
          $('#violationsTable tbody').on('click', '.save-amount', function() {
            const $row = $(this).closest('tr');
            const $amount = $row.find('.amount');
            const $editButton = $row.find('.edit-amount');
            const newAmount = $amount.find('input').val();

            // Store the original HTML of the amount element
            const originalHtml = $amount.data('original-amount');

            // Update the amount in Firebase
            const violationRef = doc(db, 'violationList', $row.find('td:eq(0)').text());
            updateDoc(violationRef, { amount: newAmount }).then(() => {
              // Update the amount in the table
              $amount.text(newAmount);

              // Show the edit button again
              $editButton.show();

              // Store the new HTML of the amount element
              $amount.data('original-amount', originalHtml.replace('{AMOUNT}', newAmount));
            }).catch((error) => {
              console.error('Error updating amount:', error);
            });
          });

          // Store the original amount HTML in a data attribute so it can be restored later
          $('#violationsTable tbody').find('.amount').each(function() {
            $(this).data('original-amount', $(this).html());
          });

          $('#loadingMain').removeClass('d-flex');
          $('#loadingMain').addClass('d-none');
        });
      }  

      function showProfilePage(page) {
        $('#loadingMain ').removeClass('d-flex  ');
        $('#loadingMain ').addClass('d-none');

        setActivePage(page);

        $('#loginScreen').addClass('d-none');
        $('#dashboardScreen').addClass('d-none');
        $('#transactionsScreen').addClass('d-none');
        $('#usersScreen').addClass('d-none');
        $('#violationsScreen').addClass('d-none');

        // Show current page
        $('#profileScreen').removeClass('d-none');

        onAuthStateChanged(auth, (user) => {
          if (user) {
            // User is signed in
            loadProfilePage();
          } else {
            // User is not signed in, redirect to login page
            window.location.href = 'index.html';
          }
        });
      }    

      function loadProfilePage() {

        const adminName = localStorage.getItem('adminName');
        const email = localStorage.getItem('email');
        $('#nameProfile').val(adminName);
        $('#emailProfile').val(email);

        $('#saveNewPassword').click(function(e) {
          e.preventDefault(); // prevent form submission

          // get password values
          var oldPassword = $('#oldPassword').val();
          var newPassword = $('#newPassword').val();
          var confirmPassword = $('#confirmPassword').val();

          if (newPassword !== confirmPassword) {
            // handle password mismatch error
            alert('Password and Confirm Password must be matched!');
          } else if (newPassword.length < 6) {
            alert('Password must be greater than or equal to 6!');
          } else {

            $('#loadingMain').addClass('d-flex');
            $('#loadingMain').removeClass('d-none');
            // proceed with password change
            updatePassword(auth.currentUser, newPassword)
            .then(() => {
              // password changed successfully
              signOut(auth)
              .then(() => {
                $('#loadingMain ').removeClass('d-flex  ');
                $('#loadingMain ').addClass('d-none');
                alert("Password changed successfully! Please relogin.");
                window.location.href = 'index.html';
              })
              .catch((error) => {
                // An error happened.
              });
            })
            .catch((error) => {
              // handle error
              alert("Error changing password: " + error.message);
              $('#loadingMain ').removeClass('d-flex  ');
              $('#loadingMain ').addClass('d-none');
            });
          }
        }); 
      }

      function showResetPage(page) {

        // Show current page
        $('#resetScreen').removeClass('d-none');

        loadResetPage();
      }    

      function loadResetPage() {

      
        $('#resetPasswordButton').click(function(e) {
          e.preventDefault(); // prevent form submission

          var regEmail = $('#resetEmail').val();

          var found = false;
          const usersList = collection(db, 'users/');
          onSnapshot(usersList, async (usersListQuerySnapshot) => {
            usersListQuerySnapshot.forEach((u) => {
              if (u.data().email == regEmail && u.data().type == 'admin') {
                found = true;
              }
            });

            if (!found) {
              alert('Registered email is not valid!');
            } else {

              // proceed with reset password
              sendPasswordResetEmail(auth, regEmail)
              .then(() => {
                // password changed successfully
                signOut(auth)
                .then(() => {
                  alert("The reset password instruction has been sent to your email!");
                  window.location.href = 'index.html';
                })
                .catch((error) => {
                  // An error happened.
                });
              })
              .catch((error) => {
                // handle error
                console.error("Error sending reset password: " + error.message);
              });
            }
          });

          
        }); 
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- Add Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- CSS file -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.11.2/datatables.min.css"/>


    <title>Admin Login</title>

    <style>
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: 200px;
        padding: 15px;
        background-color: #333;
        color: #fff;
        z-index: 1; /* Add this line */
      }

      .sidebar-sticky {
        position: sticky;
        top: 0;
      }

      .sidebar ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .sidebar ul li a {
        display: block;
        padding: 10px;
        color: #fff;
        text-decoration: none;
      }

      .sidebar ul li a.active {
        background-color: #555;
      }

      .content {
        margin-left: 200px;
        padding: 15px;
        z-index: 0; /* Add this line */
      }
    </style>
  </head>
  <body>


    <div id="loginScreen" class="d-none">
      <div class="container mt-5">
        <div class="row justify-content-center">
          
          <div class="col-md-6">
            
            <div class="card">
              <div class="card-header d-flex">
                <h4>Login</h4>
                <div id="loading" class="mx-2 d-none justify-content-center align-items-center">
                  <div class="spinner-border text-primary" role="status">
                  </div>
                </div>
              </div>

              <div class="card-body">
                <form id="#login-form">
                  <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" class="form-control" id="email" required>
                    <div class="invalid-feedback">Please enter a valid email address.</div>
                  </div>
                  <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" class="form-control" id="password" required>
                    <div class="invalid-feedback">Please enter a password.</div>
                  </div>
                  <button id="submit" type="submit" class="btn btn-primary btn-block">Login</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="menuScreen" class="d-none">
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-2 col-md-3 col-sm-4 bg-dark sidebar">
            <div class="sidebar-sticky">
              <ul class="nav flex-column">
                <li class="nav-item">
                  <a class="nav-link active" href="?page=dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="?page=violations">
                    <i class="fas fa-list"></i> Violation List
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="?page=logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                  </a>
                </li>
              </ul>
            </div>
          </div>

          <div class="col-lg-10 col-md-9 col-sm-8 content">

            <div id="dashboardScreen" class="d-none">
              <div class="row justify-content-center">
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">Card 1</h5>
                      <p class="card-text">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">Card 2</h5>
                      <p class="card-text">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">Card 3</h5>
                      <p class="card-text">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">Card 4</h5>
                      <p class="card-text">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="violationsScreen" class="d-none">
              <h1>Violations</h1>
              <hr>
              <table id="violationsTable" class="table table-striped table-bordered table-sm" style="width:100%">
                <thead>
                  <tr>
                    <th>Ref #</th>
                    <th>Full Name</th>
                    <th>Address</th>
                    <th>Birthdate</th>
                    <th>License #</th>
                    <th>Violations</th>
                    <th>Total Fee</th>
                    <th>Plate #</th>
                    <th>Registered #</th>
                    <th>Vehicle #</th>
                    <th>Vehicle Type</th>
                    <th>License Confiscated?</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>

          </div> 
        </div>     
      </div>  
    </div>

    

        <!--div id="tableViolation" class="d-none container">
          <div class="container mt-5">
          <div class="row justify-content-center">
          <h1 class="title">Violations</h1>
          <hr>
          <button id="logout" class="btn btn-primary mb-4" type="button">Logout</button>

          <table id="violationTable" class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Ref #</th>
                <th>Full Name</th>
                <th>Violations</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>   
        </div>  
        </div> 
        </div>

        <div id="tableVehicle" class="d-none container">
          <h1 class="title">Vehicles</h1>
          <hr>
          <button id="vehicleBack" class="btn btn-primary mb-4" type="button">Back</button>
          
          <table id="vehicleTable" class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Type</th>
                <th>Plate No.</th>
                <th>RFID</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>  
        </div>
      </div>
    </div-->

    



    <!-- Add Bootstrap JavaScript -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <!-- JavaScript files -->
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.11.2/datatables.min.js"></script>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-analytics.js";
      import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
      import { doc, getDoc, getFirestore, getDocs, collection, onSnapshot} from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyAYu3wN2JvXTBI5gNOV1Nn8FlJzuUdwQZQ",
        authDomain: "licenseplate-45ab1.firebaseapp.com",
        databaseURL: "https://licenseplate-45ab1-default-rtdb.firebaseio.com",
        projectId: "licenseplate-45ab1",
        storageBucket: "licenseplate-45ab1.appspot.com",
        messagingSenderId: "943920119656",
        appId: "1:943920119656:web:e7021424dbf721c14220dd",
        measurementId: "G-MYX8SM7CV3"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth();
      const db = getFirestore();

      $(document).ready(function() {

        routePage();   

        // Add click event to all nav links
        $('.nav-link').click(function(e) {
          // Remove active class from all nav links
          $('.nav-link').removeClass('active');
          // Add active class to clicked link
          $(this).addClass('active');
        });


        startLogin();
        
        // Add event listener for field change
        $('#email, #password').on('input', function(event) {
          // Remove error message when user starts typing
          if (this.checkValidity()) {
            $(this).removeClass('is-invalid');
          }
        });

        function routePage() {
          // Get the URL query parameters
          var queryParams = new URLSearchParams(window.location.search);
          
          // Check if the 'page' parameter is present and set to 'dashboard'
          if (queryParams.has('page')) {
            var page = queryParams.get('page');
            if (page === 'dashboard') {
              onAuthStateChanged(auth, (user) => {
                if (user) {
                  // User is signed in, show the dashboard
                  setActivePage(page);
                  showDashboardPage();
                } else {
                  // User is not signed in, redirect to login page
                  window.location.href = 'index.html';
                }
              });
            } else if (page === 'violations') {
              onAuthStateChanged(auth, (user) => {
                if (user) {
                  // User is signed in, show the violations
                  setActivePage(page);
                  showViolationsPage();
                } else {
                  // User is not signed in, redirect to login page
                  window.location.href = 'index.html';
                }
              });
            } else if (page === 'logout') {
              signOut(auth)
              .then(() => {
                window.location.href = 'index.html';
              })
              .catch((error) => {
                // An error happened.
              });
            }
          } else {
            $('#loginScreen').removeClass('d-none');
          }
        }

        function startLogin() {
          // Add event listener for form submission
          $('#submit').click(function(event) {
            event.preventDefault();
            // Get form fields
            var emailInput = $('#email');
            var passwordInput = $('#password');
            var email = emailInput.val();
            var password = passwordInput.val();
            
            // Check if email and password fields are valid
            if (!emailInput[0].checkValidity()) {
              // If not valid, show error message
              emailInput.addClass('is-invalid');
            } else if (!passwordInput[0].checkValidity()) {
              // If password field is empty, show error message
              passwordInput.addClass('is-invalid');
              passwordInput.siblings('.invalid-feedback').text('Please enter a password.');
            } else {

              // Show loading spinner
              $('#loading').removeClass('d-none');

              // Sign in with email and password using Firebase Auth
              signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                  // User authenticated successfully
                  checkUserLevel(userCredential.user.uid);
                })
                .catch((error) => {
                  // Handle Firebase Auth errors
                  var errorCode = error.code;
                  var errorMessage = error.message;
                  console.error(errorCode + ': ' + errorMessage);

                  if (errorCode === 'auth/user-not-found' || errorCode === 'auth/wrong-password') {
                    alert('Invalid credentials!');
                  } else if (errorCode === 'auth/too-many-requests') {
                    alert('Access to this account has been temporarily disabled due to many failed login attempts. You can immediately restore it by resetting your password or you can try again later.');
                  }

                  // Hide loading spinner
                  $('#loading').addClass('d-none');
                });
              }
          });
        }

        // Function to check the user's level
        function checkUserLevel(uid) {
          const userRef = doc(db, "users", uid);

          getDoc(userRef).then((doc) => {
            if (doc.exists()) {
              // Get user level from document data
              var userLevel = doc.data().type;

              if (userLevel === 'admin') {
                // User is an admin
                successfulLogin();
              } else {
                // Show error message
                alert('You do not have permission to access this page.');
              }
            } else {
              // User document does not exist
              console.log('User document does not exist');
            }
            // Hide loading spinner
            $('#loading').addClass('d-none');

          }).catch((error) => {
            // Handle errors
            console.log(error);

            // Hide loading spinner
            $('#loading').addClass('d-none');
          });
        }

        function successfulLogin() {
          console.log('Successful logged in');

          // Redirect to dashboard page
          window.location.href = '?page=dashboard';
        }

        function setActivePage(page) {
          // Set active class to menu item based on current page URL
          $('.nav-link').each(function(){
            var linkPage = this.href.substring(this.href.lastIndexOf('/')+1);

            if (linkPage.includes(page)) {
              $(this).addClass('active');
            } else {
              $(this).removeClass('active');
            }
          });
        }

        function showDashboardPage() {
          console.log('Showing dashboard page');
          $('#loginScreen').addClass('d-none');
          $('#violationsScreen').addClass('d-none');
          $('#menuScreen').removeClass('d-none');
          $('#dashboardScreen').removeClass('d-none');
        }



        function showViolationsPage() {
          console.log('Showing violation page');
          $('#loginScreen').addClass('d-none');
          $('#dashboardScreen').addClass('d-none');
          $('#menuScreen').removeClass('d-none');

          // Get Plate No Details
          const plateNoDetails = collection(db, 'plateNoDetails/');
          onSnapshot(plateNoDetails, (plateNoDetailsQuerySnapshot) => {

            $('#violationsScreen').removeClass('d-none');

            // Populate Violations Table
            const violationsDataTable = $('#violationsTable').DataTable();
            violationsDataTable.clear(); // clear the table before adding new rows

            const plateNoDetailsCount = plateNoDetailsQuerySnapshot.size;


            let violationString = ''; 

            let violationAmount = 0;
            let i = 0;

            plateNoDetailsQuerySnapshot.forEach((pd) => {
              console.log(pd.id, " => ", pd.data());

              // Get Violation List
              const violationList = collection(db, 'violationList/');
              onSnapshot(violationList, (violationListQuerySnapshot) => {
                i++;

                var pdData = pd.data();
                var licenseConfString = 'No';
                if (pdData.licconf == 1) {
                  licenseConfString = 'Yes';
                }
                

                pdData.violations.forEach((vID) => {    
                  
                  violationListQuerySnapshot.forEach((vl) => {

                    if (vl.id == vID) {
                      violationString = violationString + '*' + vl.data().type + '-' + vl.data().amount + '\n';
                      violationAmount = violationAmount + parseFloat(vl.data().amount);
                    }
                  });
                  
                });

                violationsDataTable.row.add([pd.id, pdData.fname + ' ' + pdData.mname[0] + '. ' + pdData.lname, pdData.address, pdData.bdate, pdData.lnumber, violationString, violationAmount.toFixed(2), pdData.no, pdData.rnumber, pdData.vnumber, pdData.vtype, licenseConfString]);
                
                if (i == plateNoDetailsCount) {
                  console.log(violationString);
                  violationsDataTable.draw(); // redraw the table with the updated rows
                  //violationsDataTable.row.add([pd.id, pdData.fname + ' ' + pdData.mname[0] + '. ' + pdData.lname, pdData.address, pdData.bdate, pdData.lnum, violationString, 0, pdData.no, pdData.rnum, pdData.vnum, pdData.vtype, pdData.lconf]);
                }
                violationString = '';
                violationAmount = 0;
              });
            });


          });
        }
      });
    </script>
  </body>
</html>
